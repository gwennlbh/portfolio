name: Visual diffing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  prepare:
    name: Prepare
    uses: ./.github/workflows/_build.yml
    with:
      artifact: dist
      lang: fr
      locale: fr-FR
      build-commit: testing

  update:
    name: Update screenshots
    if: github.event_name == 'push'
    needs: [prepare]
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/gwennlbh/playwright-bun:v1.55.1
    steps:
      - uses: actions/checkout@v5

        # Probably due to using a container
      - name: Fix dubious ownership of .git dir
        run: git config --global --add safe.directory $(pwd)

      - name: Remove git pre-push hook
        run: echo "" > .husky/pre-push

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Get built site
        uses: actions/download-artifact@v5
        with:
          name: dist

      - name: Update screenshots
        run: bunx playwright test --update-snapshots --update-source-method overwrite

      - name: Commit updated screenshots
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: âœ… Update screenshots
          file_pattern: screenshots/

  test:
    name: Test
    if: github.event_name == 'pull_request'
    needs: [prepare]
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/gwennlbh/playwright-bun:v1.55.1
    environment:
      name: Visual diffing for PR #${{ github.event.pull_request.number }}
      url: https://gwennlbh.github.io/portfolio/pr-${{ github.event.pull_request.number }}/
    steps:
      - uses: actions/checkout@v5

      # Probably due to using a container
      - name: Fix dubious ownership of .git dir
        run: git config --global --add safe.directory $(pwd)

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Remove git pre-push hook
        run: echo "" > .husky/pre-push

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Get built site
        uses: actions/download-artifact@v3
        with:
          name: dist

      - name: Verify screenshots
        run: bunx playwright test

      - if: ${{ !cancelled() }}
        id: gh-pages
        name: Upload report to github pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: playwright-report
          target-folder: pr-${{ github.event.pull_request.number }}
          force: true
          single-commit: true
          clean-exclude: |
            .nojekyll
            pr-*
